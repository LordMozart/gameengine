<html>
<head>
  <meta charset="UTF-8">
  <title>Top Down 3D Shooter with Upgrades</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #gameCanvas {
      width: 100vw;
      height: 100vh;
    }
    #hud {
      position: fixed;
      top: 20px;
      left: 20px;
      color: #fff;
      font-size: 24px;
      text-shadow: 2px 2px 2px #000;
    }
    #healthBar {
      width: 200px;
      height: 20px;
      background: #333;
      margin-top: 10px;
    }
    #health {
      width: 100%;
      height: 100%;
      background: #ff3333;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div id="hud">
    Score: <span id="score">0</span>
    <div id="healthBar"><div id="health"></div></div>
  </div>
  <canvas id="gameCanvas"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // Set up the scene, camera, and renderer
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({
      canvas: document.getElementById('gameCanvas'),
      antialias: true
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    // Lighting setup
    const ambientLight = new THREE.AmbientLight(0x404040, 1);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
    directionalLight.position.set(5, 5, 5);
    directionalLight.castShadow = true;
    scene.add(directionalLight);

    // Player setup
    const playerGeometry = new THREE.BoxGeometry(1, 1, 1);
    const playerMaterial = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
    const player = new THREE.Mesh(playerGeometry, playerMaterial);
    player.position.y = 0.5;
    player.castShadow = true;
    player.receiveShadow = true;
    scene.add(player);

    // Camera setup
    camera.position.set(0, 10, 10);
    camera.lookAt(new THREE.Vector3(0, 0, 0));

    // Floor texture (Garfield image)
    const floorTexture = new THREE.TextureLoader().load('garfield.png');
    const floorGeometry = new THREE.PlaneGeometry(50, 50);
    const floorMaterial = new THREE.MeshBasicMaterial({ map: floorTexture });
    const floor = new THREE.Mesh(floorGeometry, floorMaterial);
    floor.rotation.x = -Math.PI / 2;
    floor.position.y = -0.5;
    floor.receiveShadow = true;
    scene.add(floor);

    // Game state variables
    let score = 0;
    let health = 100;
    let enemies = [];
    let lastEnemySpawn = 0;
    let playerSpeed = 0.2;
    camera.position.set(0, 20, 0);
    camera.lookAt(0, 0, 0);

    // Upgrade system variables
    let upgradeCosts = {
      speed: 100,
      health: 200,
      damage: 150,
      multishot: 500
    };
    let upgradeMultipliers = {
      speed: 1.1,
      health: 1.25,
      damage: 1.2
    };
    let multishotLevel = 0;

    // Movement and key events
    const keys = {};
    window.addEventListener('keydown', (e) => keys[e.key] = true);
    window.addEventListener('keyup', (e) => keys[e.key] = false);

    // Move player function
    function movePlayer() {
      if (keys['w']) player.position.z -= playerSpeed;
      if (keys['s']) player.position.z += playerSpeed;
      if (keys['a']) player.position.x -= playerSpeed;
      if (keys['d']) player.position.x += playerSpeed;
    }

    // Enemy creation function
    function createEnemy() {
      const enemyType = Math.random() < 0.2 ? 'yellow' : 'red';  // 20% chance for yellow enemies
      const enemyGeometry = new THREE.BoxGeometry(1, 1, 1);
      const enemyMaterial = new THREE.MeshPhongMaterial({ color: enemyType === 'yellow' ? 0xffff00 : 0xff0000 });
      const enemy = new THREE.Mesh(enemyGeometry, enemyMaterial);
      const side = Math.floor(Math.random() * 4);
      switch (side) {
        case 0: enemy.position.set(-25, 0.5, Math.random() * 50 - 25); break;
        case 1: enemy.position.set(25, 0.5, Math.random() * 50 - 25); break;
        case 2: enemy.position.set(Math.random() * 50 - 25, 0.5, -25); break;
        case 3: enemy.position.set(Math.random() * 50 - 25, 0.5, 25); break;
      }
      enemy.health = enemyType === 'yellow' ? 2 : 1;  // Double health for yellow enemies
      enemy.castShadow = true;
      enemy.receiveShadow = true;
      scene.add(enemy);
      enemies.push(enemy);
    }

    // Enemy update and collision handling
    function updateEnemies() {
      enemies.forEach((enemy) => {
        const direction = new THREE.Vector3().subVectors(player.position, enemy.position).normalize();
        enemy.position.add(direction.multiplyScalar(0.05));  // Slow enemy movement towards player

        // Enemy collision detection with player
        if (enemy.position.distanceTo(player.position) < 1) {
          health -= 10;
          document.getElementById('health').style.width = health + '%';
          if (health <= 0) {
            alert('Game Over! Score: ' + score);
            location.reload();
          }
        }
      });
    }

    // Upgrade function
    function applyUpgrade(upgrade) {
      if (score >= upgradeCosts[upgrade]) {
        score -= upgradeCosts[upgrade];
        document.getElementById('score').textContent = score;

        // Apply upgrade based on type
        if (upgrade === 'speed') {
          playerSpeed *= upgradeMultipliers[upgrade];
        } else if (upgrade === 'health') {
          health += 10 * upgradeMultipliers[upgrade];
          document.getElementById('health').style.width = health + '%';
        } else if (upgrade === 'damage') {
          // Damage upgrade logic (can increase bullet power)
        } else if (upgrade === 'multishot') {
          multishotLevel++;
          upgradeCosts[upgrade] *= 1.5;  // Increase multishot upgrade cost after purchase
        }
      }
    }

    // Upgrade buttons (and the "multishot" upgrade)
    document.getElementById('upgradeSpeed').addEventListener('click', () => applyUpgrade('speed'));
    document.getElementById('upgradeHealth').addEventListener('click', () => applyUpgrade('health'));
    document.getElementById('upgradeDamage').addEventListener('click', () => applyUpgrade('damage'));
    document.getElementById('upgradeMultishot').addEventListener('click', () => applyUpgrade('multishot'));

    // Game loop function
    function animate() {
      requestAnimationFrame(animate);

      // Handle player movement
      movePlayer();

      // Spawn enemies every few seconds
      if (Date.now() - lastEnemySpawn > 2000) {
        createEnemy();
        lastEnemySpawn = Date.now();
      }

      // Update enemy positions and handle collisions
      updateEnemies();

      // Render the scene
      renderer.render(scene, camera);
    }

    // Start the game loop
    animate();

    // Window resizing handling
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>

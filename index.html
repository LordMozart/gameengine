<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D FPS Game</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
    #crosshair {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 10px;
      height: 10px;
      background: red;
      transform: translate(-50%, -50%);
      border-radius: 50%;
    }
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-family: Arial, sans-serif;
    }
    #gunCanvas {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 150px;
      height: 150px;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="crosshair"></div>
  <div id="hud">Health: <span id="playerHealth">100</span> | Score: <span id="score">0</span></div>
  <canvas id="gunCanvas"></canvas>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/110/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r110/examples/js/loaders/GLTFLoader.js"></script>
  <script>
    // Main scene setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Gun scene setup
    const gunCanvas = document.getElementById('gunCanvas');
    const gunRenderer = new THREE.WebGLRenderer({ canvas: gunCanvas });
    gunRenderer.setSize(150, 150); // Set canvas size
    const gunScene = new THREE.Scene();
    const gunCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000); // Adjusted to 1:1 aspect ratio for gun

    // Load gun model
    const loader = new THREE.GLTFLoader();
    loader.load('scene.gltf', (gltf) => {
      const gun = gltf.scene;
      gun.scale.set(0.5, 0.5, 0.5); // Adjust scale
      gun.position.set(0, 0, -1); // Position it slightly off the camera
      gunScene.add(gun);
      gunCamera.position.set(0, 0, 5); // Position the gun in view for the mini camera
    });

    // Camera and movement handling for the main game world
    const keys = {};
    let isJumping = false;
    let velocityY = 0;
    const gravity = -0.01;

    document.addEventListener('keydown', (e) => keys[e.key] = true);
    document.addEventListener('keyup', (e) => keys[e.key] = false);

    const playerSpeed = 0.1;
    const jumpSpeed = 0.3;

    function handlePlayerMovement() {
      const forward = new THREE.Vector3();
      const right = new THREE.Vector3();

      camera.getWorldDirection(forward);
      forward.y = 0;
      forward.normalize();

      right.crossVectors(forward, camera.up).normalize();

      const newPosition = camera.position.clone();

      if (keys['w']) newPosition.addScaledVector(forward, playerSpeed);
      if (keys['s']) newPosition.addScaledVector(forward, -playerSpeed);
      if (keys['a']) newPosition.addScaledVector(right, -playerSpeed);
      if (keys['d']) newPosition.addScaledVector(right, playerSpeed);

      velocityY += gravity;
      newPosition.y += velocityY;

      if (newPosition.y < 1) {
        newPosition.y = 1;
        velocityY = 0;
        isJumping = false;
      }

      newPosition.clamp(
        new THREE.Vector3(-50, 1, -50),
        new THREE.Vector3(50, 10, 50)
      );

      camera.position.copy(newPosition);
    }

    // Skybox setup
    const skyTexture = new THREE.TextureLoader().load('sky.jpg');
    skyTexture.mapping = THREE.EquirectangularRefractionMapping;
    scene.background = skyTexture;

    // Add ground with texture
    const floorGeometry = new THREE.PlaneGeometry(200, 200);
    const floorTexture = new THREE.TextureLoader().load('ground.jpg');
    const floorMaterial = new THREE.MeshBasicMaterial({ map: floorTexture });
    const floor = new THREE.Mesh(floorGeometry, floorMaterial);
    floor.rotation.x = - Math.PI / 2;
    scene.add(floor);

    // Box setup with random height
    const boxTexture = new THREE.TextureLoader().load('garfield.png');
    const boxes = [];
    for (let i = 0; i < 10; i++) {
      const boxGeometry = new THREE.BoxGeometry(2, Math.random() * 4 + 1, 2); // Random height
      const boxMaterial = new THREE.MeshBasicMaterial({ map: boxTexture });
      const box = new THREE.Mesh(boxGeometry, boxMaterial);
      box.position.set(
        Math.random() * 80 - 40,
        1,
        Math.random() * 80 - 40
      );
      scene.add(box);
      boxes.push(box);
    }

    // Game loop
    function animate() {
      requestAnimationFrame(animate);
      handlePlayerMovement();
      renderer.render(scene, camera); // Render the game world
      gunRenderer.render(gunScene, gunCamera); // Render the gun scene
    }

    animate();
  </script>
</body>
</html>
